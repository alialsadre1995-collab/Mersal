<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>ArabChat Pro</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  :root{
    --bg:#0d0f13;--card:#151923;--muted:#6f7a8a;--accent:#3aa0ff;
    --ok:#19c37d;--warn:#ffcc00;--err:#ff5c5c;--line:#212837;
    --gold:#f5c542;--delegate:#8be9fd;
    --composerH: 100px; /* يُضبط بالسكربت */
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:#e9edf5;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Tahoma,sans-serif}

  .app{height:100svh;display:flex;flex-direction:column;max-width:900px;margin:0 auto;
       padding-bottom:env(safe-area-inset-bottom)}

  /* شريط العنوان */
  .topbar{
    background:var(--card);border-bottom:1px solid var(--line);
    padding:10px 12px;display:flex;align-items:center;gap:10px;
    position:sticky;top:0;z-index:5
  }
  .title{font-weight:700}
  .pill{margin-inline-start:auto;background:#0f131c;border:1px solid var(--line);
        padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .toggleSide{background:#0f131c;border:1px solid var(--line);border-radius:8px;padding:6px 10px;color:#e9edf5}

  /* منطقة المحتوى */
  .content{flex:1;display:flex;min-height:0}
  .chat{flex:1;display:flex;flex-direction:column;min-width:0}
  .msgs{flex:1;overflow:auto;padding:10px;scroll-behavior:smooth;padding-bottom:var(--composerH)}
  .sys{color:var(--muted);font-size:13px;margin:8px 0}
  .row{display:flex;gap:8px;align-items:flex-start;margin:6px 0}
  .flag{width:18px;height:12px;border:1px solid #0002;object-fit:cover;margin-top:3px}
  .bubble{background:#0f131c;border:1px solid var(--line);padding:8px 10px;border-radius:10px;max-width:100%;word-break:break-word}
  .nick{font-weight:700;margin-inline-end:6px}

  /* قائمة المتواجدين */
  .side{flex:0 0 180px;width:180px;overflow:auto;background:#0f131c;border-inline-start:1px solid var(--line)}
  .side h4{margin:10px;font-size:14px;color:var(--muted)}
  .user{display:flex;align-items:center;gap:8px;padding:8px 10px;border-top:1px solid #0b0e14;cursor:pointer}
  .user:hover{background:#101522}
  .ranks{margin-inline-start:auto;display:flex;gap:6px;font-size:13px}

  /* شريط الإدخال */
  .composer{
    position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--line);
    padding:8px;display:flex;gap:8px;align-items:center
  }
  input,button,select{
    background:#0f131c;border:1px solid var(--line);color:#e9edf5;border-radius:10px;padding:10px 12px;font-size:15px
  }
  input:focus{outline:none;border-color:#36507a}
  .btn{background:var(--accent);border:none;color:#fff;font-weight:700}
  .btn:active{opacity:.9}
  .grow{flex:1;min-width:0}
  .adminOnly{display:none} /* تُظهر لاحقًا إذا أدمن */

  /* شاشة الدخول */
  .login{
    position:fixed;inset:0;background:rgba(13,15,19,.97);display:flex;align-items:center;justify-content:center;z-index:20
  }
  .card{
    width:min(92vw,420px);background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:10px
  }
  .hint{color:var(--muted);font-size:12px}

  /* نافذة الإجراءات */
  .sheet{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;z-index:30;background:#0006}
  .sheet > div{background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;width:min(92vw,460px);border-top:1px solid var(--line)}
  .sheet .rowbtn{display:flex;gap:8px;padding:10px;border-bottom:1px solid #0b0e14}
  .rowbtn button{flex:1}
  .badge{color:#ffd34d}
  .adminName{color:#ffd34d}
  .delegName{color:var(--delegate)}
  .ok{color:var(--ok)} .err{color:var(--err)}

  /* وضع الجوال */
  @media (max-width: 700px){
    .side{ display:none; position:fixed; top:48px; right:0; height:auto; max-height:70vh;
           width:80vw; z-index:8; box-shadow:0 10px 30px #0008; }
    .app.show-side .side{ display:block; }
  }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="title">💬 شات الوطن العربي</div>
    <button id="toggleSide" class="toggleSide" title="المتواجدون">👥</button>
    <div class="pill" id="status">غير متصل</div>
  </div>

  <div class="content">
    <div class="chat">
      <div id="msgs" class="msgs"></div>

      <div class="composer">
        <input id="to" placeholder="خاص إلى (اختياري)" style="max-width:180px">
        <input id="text" class="grow" placeholder="اكتب رسالة..." inputmode="text" autocomplete="off">
        <button id="send" class="btn">إرسال</button>
      </div>
    </div>

    <aside class="side" id="side">
      <h4>👥 المتواجدون</h4>
      <div id="users"></div>
    </aside>
  </div>
</div>

<!-- شاشة الدخول -->
<div class="login" id="login">
  <div class="card">
    <h3 style="margin:0 0 6px">دخول</h3>
    <input id="nick" placeholder="الاسم (إنجليزي فقط)">
    <details>
      <summary style="cursor:pointer;color:var(--muted)">تسجيل دخول مشرف</summary>
      <input id="adminUser" placeholder="اسم الأدمن" value="ArabAdmin">
      <input id="adminPass" placeholder="رمز الأدمن" value="az77@">
    </details>
    <button id="go" class="btn">دخول الغرفة</button>
    <div class="hint">يسمح فقط بحروف إنجليزية/أرقام (3-20). الأسماء العربية تتحول إلى Guest تلقائيًا.</div>
  </div>
</div>

<!-- ورقة إجراءات المستخدم -->
<div class="sheet" id="sheet">
  <div>
    <div class="rowbtn" style="justify-content:center;font-weight:700" id="sheetTitle">الإجراءات</div>
    <div class="rowbtn adminOnly"><button id="star">⭐ نجمة</button><button id="unstar">☆ إزالة نجمة</button></div>
    <div class="rowbtn adminOnly"><button id="delegate">~ توكيل</button><button id="undelegate">إلغاء التوكيل</button></div>
    <div class="rowbtn adminOnly"><button id="mute">🔇 كتم</button><button id="unmute">🔊 فك الكتم</button></div>
    <div class="rowbtn adminOnly"><button id="kick">🚪 طرد</button><button id="ban">🚫 حظر IP</button></div>
    <div class="rowbtn"><button id="whois">🔍 كشف معلومات</button><button id="closeSheet">إغلاق</button></div>
    <div class="rowbtn adminOnly"><button id="clearAll" style="background:#333;color:#fff">🧹 مسح السجل</button></div>
  </div>
</div>

<script>
  // ===== Socket =====
  const socket = io({ transports: ["websocket","polling"] });
  const $ = id => document.getElementById(id);

  // عناصر
  const appEl = $("app");
  const login = $("login"); const nickInp = $("nick");
  const adminUser = $("adminUser"); const adminPass = $("adminPass");
  const statusEl = $("status"); const msgs = $("msgs");
  const usersBox = $("users"); const text = $("text"); const to = $("to");
  const composerEl = document.querySelector(".composer");

  const sheet = $("sheet"); let sheetTarget = null;
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);

  let ME = { nick: null, admin: false };

  // زر إظهار/إخفاء المتواجدين على الجوال
  $("toggleSide").onclick = ()=> appEl.classList.toggle("show-side");

  // احسب ارتفاع شريط الكتابة وأضفه كمتغير CSS لعدم تغطية الرسائل
  function setComposerHeightVar(){
    const h = composerEl ? composerEl.offsetHeight : 90;
    document.documentElement.style.setProperty("--composerH", (h + 16) + "px");
  }
  window.addEventListener("resize", setComposerHeightVar);
  window.addEventListener("orientationchange", setComposerHeightVar);
  setTimeout(setComposerHeightVar, 0);
  setTimeout(setComposerHeightVar, 300);

  // إبقاء الكيبورد ظاهرًا بالآيفون وعدم اهتزاز الشاشة
  if (isIos){
    text.setAttribute("enterkeyhint","send");
    text.addEventListener("focus",()=>{document.body.style.height="100svh"});
    text.addEventListener("blur",()=>{document.body.style.height=""});
  }

  // دخول مع ACK يرجع حالة الأدمن ويظهر أزراره فقط إن كان أدمن
  $("go").onclick = () => {
    const wantAdmin = adminUser.value.trim() === nickInp.value.trim();
    socket.emit("login", {
      nick: nickInp.value.trim(),
      admin: wantAdmin,
      pass: adminPass.value
    }, (res) => {
      if (res?.ok) {
        ME = res.user || { nick: nickInp.value.trim(), admin: false };
        document.querySelectorAll(".adminOnly").forEach(el=>{
          el.style.display = ME.admin ? "" : "none";
        });
      } else {
        alert("تعذر الدخول");
      }
    });
  };

  $("send").onclick = send;
  text.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey){ e.preventDefault(); send(); }
  });

  function send(){
    const m = text.value.trim();
    if (!m) return;
    const dest = to.value.trim();
    if (dest) socket.emit("pm", { to: dest, text: m });
    else socket.emit("msg", m);
    text.value = "";
    if (isIos) setTimeout(()=>text.focus(), 0);
  }

  // عرض التاريخ/الرسائل
  socket.on("history", list => list.forEach(drawEvent));
  socket.on("system", t => drawEvent({ type:"system", text:t }));
  socket.on("msg", drawEvent);
  socket.on("pm", e => {
    to.value = e.from && e.from !== "me" ? e.from : to.value;
    drawEvent({ type:"pm", ...e });
  });
  socket.on("clear", () => { msgs.innerHTML=""; });

  function drawEvent(e){
    if (e.type === "system"){
      const div = document.createElement("div");
      div.className = "sys"; div.textContent = e.text;
      msgs.appendChild(div);
    } else if (e.type === "msg"){
      const row = document.createElement("div"); row.className="row";
      row.innerHTML = `<img class="flag" alt="" src="https://flagcdn.com/24x18/${(e.country||"??").toLowerCase()}.png"
                        onerror="this.style.visibility='hidden'">
                       <div class="bubble"><span class="nick">${e.nick}</span>${escapeHTML(e.text)}</div>`;
      msgs.appendChild(row);
    } else if (e.type === "pm"){
      const row = document.createElement("div"); row.className="row";
      row.innerHTML = `<div class="bubble" style="border-color:#3a3f55;background:#121626">
          <span class="nick" style="color:#8be9fd">[خاص ${e.from||"me"} → ${e.to||""}]</span> ${escapeHTML(e.text)}
      </div>`;
      msgs.appendChild(row);
    }
    msgs.scrollTop = msgs.scrollHeight;
  }

  socket.on("users", list => {
    usersBox.innerHTML = "";
    list.forEach(u => {
      const d = document.createElement("div");
      d.className = "user";
      d.innerHTML = `
        <img class="flag" alt="" src="https://flagcdn.com/24x18/${(u.country||"??").toLowerCase()}.png"
             onerror="this.style.visibility='hidden'">
        <div class="${u.admin?'adminName':''} ${u.delegate?'delegName':''}">${u.nick}</div>
        <div class="ranks">
          ${u.admin?'<span title="مشرف">🛡️</span>':''}
          ${u.delegate?'<span title="~">~</span>':''}
          ${u.star?'<span title="نجمة">⭐</span>':''}
        </div>`;
      d.onclick = () => openSheet(u.nick);
      usersBox.appendChild(d);
    });
    $("status").textContent = `متصل • ${list.length}`;
  });

  socket.on("kicked", msg => { alert(msg||"تم طردك"); location.reload(); });
  socket.on("banned", msg => { alert(msg||"محظور"); location.replace("about:blank"); });

  // ورقة الإجراءات
  function openSheet(n){
    sheetTarget = n;
    $("sheetTitle").textContent = `إجراءات: ${n}`;
    sheet.style.display = "flex";
  }
  $("closeSheet").onclick = ()=> sheet.style.display="none";

  const adminDo = (act) => {
    if (!ME.admin) return alert("هذه الأدوات خاصة بالمشرف.");
    socket.emit("admin:action", { action: act, target: sheetTarget });
  };
  $("star").onclick = ()=>adminDo("star");
  $("unstar").onclick = ()=>adminDo("unstar");
  $("delegate").onclick = ()=>adminDo("delegate");
  $("undelegate").onclick = ()=>adminDo("undelegate");
  $("mute").onclick = ()=>adminDo("mute");
  $("unmute").onclick = ()=>adminDo("unmute");
  $("kick").onclick = ()=>adminDo("kick");
  $("ban").onclick = ()=>adminDo("ban");
  $("clearAll").onclick = ()=>adminDo("clear");
  $("whois").onclick = ()=> socket.emit("whois", sheetTarget);

  socket.on("whois", data => {
    if (!data?.found) return alert("غير موجود");
    alert(`الاسم: ${data.nick}\nالدولة: ${data.country}\n${data.ip ? "IP: "+data.ip : ""}`);
  });

  socket.on("connect", ()=>{$("status").textContent="متصل";});
  socket.on("disconnect", ()=>{$("status").textContent="غير متصل";});

  // إغلاق شاشة الدخول بعد أول History (نجاح الدخول)
  socket.on("history", ()=> login.style.display="none");

  // أدوات
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
</script>
</body>
</html>
